<!doctype html>
<html>
  <head>
    <title>Mega #</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="jquery-ui-dist/jquery-ui.min.css">
    <style>
      .start-screen .row div {
        margin-bottom: 5px; /* TODO: remove */
      }

      #socketID {
        text-align: center;
      }

      .btn {
        padding: 6px;
        width: 135px;
      }

      .tile {
        height: 42px;
        border: 1px dashed;
      }
    </style>
    <script src="socket.io/socket.io.js"></script>
    <script src="jquery/dist/jquery.min.js"></script>
    <script src="bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="jquery-ui-dist/jquery-ui.min.js"></script>
    <script>
    // StackOverflow bullshit for highlighting autocomplete
    $.ui.autocomplete.prototype._renderItem = function(ul, item) {
      const exp = new RegExp("(?![^&;]+;)(?!<[^<>]*)(" + $.ui.autocomplete.escapeRegex(this.term) + ")(?![^<>]*>)(?![^&;]+;)", "gi");
      item.label = item.label.replace(exp, "<strong>$1</strong>");
      return $("<li></li>")
      .data("item.autocomplete", item)
      .append("<a>" + item.label + "</a>")
      .appendTo(ul);
    };
    // End of StackOverflow bullshit

    let myMark; // X or O. Yes, it's a fucking global variable. Long story.

    function challenge(opponent) {
      if (opponent == socket.id)
        return alert('Escolha alguém além de você mesmo!');

      socket.emit('challenge sent', opponent);
      alert('Desafio enviado\nAguardando resposta...');
    }

    function getTile(gridCoords, tileCoords) {
      return $(`.grid.${gridCoords} .${tileCoords}`);
    }

    function getTileCoords(tile) {
      const exp = /(t|m|b)+-+(l|m|r)/;
      const grid = tile.parents('.grid');

      // Find [t/m/b]-[l/m/r] in the tile's classes
      const tileCoords = tile.attr('class').match(exp)[0];

      // Find [t/m/b]-[l/m/r] in the grid's classes
      const gridCoords = grid.attr('class').match(exp)[0];

      return gridCoords + ' ' + tileCoords;
    }

    function makeGrid(container) {
      for (let i = 0; i < 3; i++) {
        const row = $('<div class=row/>');

        for (let j = 0; j < 3; j++)
          $('<div/>')
          .addClass('col-xs-4')
          .addClass('tmb'[i] + '-' + 'lmr'[j])
          .appendTo(row);

        container.append(row);
      }
    }

    function showGrid() {
      $('.container').removeClass('start-screen').html('');

      makeGrid($('.container'));
      $('.container .row div').addClass('grid');

      makeGrid($('.grid'));
      $('.grid .row div').addClass('tile');
    }

    function showTurnTracker() {
      $('.container').prepend(`
        <div class=row>
          <div class=col-xs-12 id=turnTracker/>
        </div>
      `);
    }

    function drawMark(tile, mark) {
      tile.addClass(mark);
      // draw the mark
      tile.text(mark);
    }

    function tileOnClick() {
      const tile = $(this);
      drawMark(tile, myMark);
      socket.emit('mark', getTileCoords(tile));
      waitForOpponent();
    }

    function myTurn() {
      $('#turnTracker').text('Sua vez');

      const activeTiles = $('.tile'); // FIXME: only select tiles that should be

      // Style the active tiles
      activeTiles.css('background-color', 'red');

      // Doesn't work with a callback, has to be a global funcion (tileOnClick)
      activeTiles.click(tileOnClick);
    }

    function waitForOpponent() {
      $('#turnTracker').text('Seu oponente está jogando...');
      $('.tile').off().removeAttr('style'); // Deactivates all tiles
    }

    function startGame() {
      showGrid();
      showTurnTracker();

      if (myMark == 'X') myTurn();
      else waitForOpponent();
    }

    const socket = io();

    socket.on('connect', data => {
      $('#socketID').text(`Sua ID: ${socket.id}`);
      socket.emit('request all users');
    });

    socket.on('update all users', allUsers => {
      $('#clientsCount').text(`${allUsers.length} jogadores online`);
      allUsers.splice(allUsers.indexOf(socket.id), 1); // Remove user from the list
      $('#challengeInput').autocomplete({source: allUsers});
    });

    socket.on('challenge received', challengerID => {
      const accepted = confirm(`Você foi desafiado por:\n${challengerID}\nAceitar?`);
      if (accepted) {
        socket.emit('challenge accepted', challengerID);
        myMark = 'O';
        startGame();
      }
    });

    socket.on('challenge accepted', opponentID => {
      alert(`${opponentID} aceitou seu desafio.\nIniciando partida...`);
      myMark = 'X';
      startGame();
    });

    socket.on('my turn', opponentPlay => {
      console.log(opponentPlay);
      const opponentMark = myMark == 'X' ? 'O' : 'X';
      const coords = opponentPlay.split(' ');
      const tile = getTile(coords[0], coords[1]);
      drawMark(tile, opponentMark);
      myTurn();
    });

    $(document).ready(() => {
      $('#challengeInput').focus(() => {
        socket.emit('request all users');
      });

      $('#challenge').click(() => {
        challenge($('#challengeInput').val());
      });
    });
    </script>
  </head>
  <body>
    <div class="container start-screen">
      <div class="row">
        <div class="col-xs-12"><h1>Mega #</h1></div>
      </div>
      <div class="row">
        <div class="col-xs-12" id="socketID">Sua ID: carregando...</div>
      </div>
      <div class="row">
        <div class="col-xs-7">
          <input type="text" class="form-control" placeholder="ID do seu oponente" id="challengeInput"/>
        </div>
        <div class="col-xs-5">
          <button class="btn btn-success" id="challenge">Desafiar Jogador</button>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-7" id="clientsCount">Carregando...</div>
        <div class="col-xs-5">
          <button class="btn btn-warning" id="random">Oponente Aleatório</button>
        </div>
      </div>
    </div>
  </body>
</html>
